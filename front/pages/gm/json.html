<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>json</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/css/oksub.css">
</head>

<body>
  <div class="ok-body">
    <form class="layui-form" id="json">
    </form>
  </div>
  <!--js逻辑-->
  <script src="/lib/layui/layui.js"></script>
  <script>
    var config_data;
    var json_data;
    layui.use(['form', 'okUtils', 'okLayer', 'laydate'], function () {
      let form = layui.form;
      let okUtils = layui.okUtils;
      let $ = layui.jquery;
      let laydate = layui.laydate;
      let okLayer = layui.okLayer;

      function jsonEditor(json, field) {
        try {
          this.fieldOption = field;
          if (!this.parseJson(json)) {
            this.error('不是有效的Json格式配置');
            return;
          }
          this.createEditor();
        } catch (e) {
          console.log(e);
          this.error(e);
        }
      }
      jsonEditor.prototype.escape = function (txt) {
        if (!txt) return "";
        return $('<div/>').text(txt).html();
      },
      jsonEditor.prototype.error = function(msg) {
        okLayer.redCrossMsg(this.escape(msg));
      },
      jsonEditor.prototype.createEditor = function() {
        let $form = $('#json');
        let fieldKey, fieldDesc, fieldValue;
        for (fieldKey in this.fieldOption) {
          fieldDesc = this.fieldOption[fieldKey];
          fieldValue = fieldDesc.useWholeValue ? this.json : okUtils.getJsonValue(this.json, fieldKey);
          let formItem = this.createFormItem(fieldKey, fieldDesc, fieldValue);
          $form.append(formItem);
        }
        $form.append('<div class="layui-form-item"><div class="layui-input-block"><button class="layui-btn" lay-submit lay-filter="save">保存</button></div></div>');
        form.render();
      }
      jsonEditor.prototype.createFormItem = function(fieldKey, fieldDesc, fieldValue) {
        if (fieldDesc.printer) {
          fieldValue = fieldDesc.printer(fieldValue);
        }

        let formItem = $('<div class="layui-form-item"></div>');
        let cb = $('<input type="checkbox" title="覆盖"/>');
        cb.attr("inputname", fieldKey.replace(".","-"));
        cb.attr("id", 'cb-'+fieldKey.replace(".","-"));
        formItem.append($('<div class="layui-input-inline" style="width:80px">').append(cb));

        if (fieldDesc.type == 'map' || fieldDesc.type == 'array') {
          this.createFormGroupItem(formItem, fieldKey, fieldDesc, fieldValue, cb);
        } else {
          this.createFormSimpleItem(formItem, fieldKey, fieldDesc, fieldValue, cb);
        }
        return formItem;
      }
      jsonEditor.prototype.createFormGroupItem = function(formItem, fieldKey, fieldDesc, fieldValue) {
        return formItem;
      }
      jsonEditor.prototype.createFormSimpleItem = function(formItem, fieldKey, fieldDesc, fieldValue, cb) {
        let line = this.createInputField(fieldKey, fieldDesc, fieldValue, cb);
        formItem.append(line.label);
        formItem.append(line.input);
        return formItem;
      }
      jsonEditor.prototype.createInputField = function(fieldKey, fieldDesc, fieldValue, ctlCheckBox) {
        let label = $('<div style="width:100px;color:#999;display:block;float:left;padding:5px 5px 0 0;"></div>');
        label.append(fieldDesc.name);

        if (fieldDesc.subFieldOption) {
          let a = $('<a href="javascript:void(0)"></a>');
          a.append($('<i class="layui-icon layui-icon-set" style="font-size: 18px; color: #1E9FFF;"></i>'));
          label.append(a);
          let that = this;
          a.on('click', function() {
            if (!ctlCheckBox.prop('checked')) {
              return;
            }
            let title = '编辑-'+fieldDesc.name;
            config_data = fieldDesc.subFieldOption;
            if (typeof(fieldDesc.subFieldOption) == 'function') {
              config_data = fieldDesc.subFieldOption(fieldKey);
            }
            if (config_data === undefined) {
              that.error('没有定义字段，请手动编辑');
              return;
            }
            json_data = "#"+fieldKey.replace(".","-");
            okLayer.open(title, "/gm/json.html", "90%", "90%", null, null);
          });
        }

        if (fieldValue !== null && typeof(fieldValue) == 'object') {
          fieldValue = okUtils.jsonToString(fieldValue);
        }
        let input;
        if (fieldDesc.type === undefined || fieldDesc.type == 'text') {
          input = $('<input type="text" class="layui-input">');
        } else if (fieldDesc.type == 'midtext') {
          input = $('<input type="text" class="layui-input" style="width:300px">');
        } else if (fieldDesc.type == 'longtext') {
          input = $('<input type="text" class="layui-input" style="width:400px">');
        } else if (fieldDesc.type == 'textarea') {
          input = $('<textarea class="layui-textarea" style="width:400px"></textarea>');
        } else if (fieldDesc.type == 'number') {
          input = $('<input type="text" class="layui-input" lay-verify="integer">');
        } else if (fieldDesc.type == 'datetime') {
          input = $('<input type="text" class="layui-input" lay-verify="datetime">');
          laydate.render({
            elem: input.get(0),
            type: 'datetime',
          });
        } else if (fieldDesc.type == 'select') {
          input = $('<select></select>');
          for (let opt in fieldDesc.options) {
            input.append($('<option></option>').attr('value', opt).text(fieldDesc.options[opt]));
          }
        } else {
          throw('未知类型: ' + fieldDesc.type);
          return;
        }

        input.attr("name", fieldKey.replace(".","-"));
        input.attr("id", fieldKey.replace(".","-"));
        if (fieldValue !== undefined && fieldValue !== null) {
          input.val(fieldValue);
        }

        if (ctlCheckBox !== undefined) {
          function setDisabled(disabled) {
            input.prop('disabled', disabled);
            if (disabled) {
              input.addClass("layui-disabled");
            } else {
              input.removeClass("layui-disabled");
            }
          }

          if (fieldValue === undefined || fieldValue === null) {
            setDisabled(true);
          } else {
            setDisabled(false);
            ctlCheckBox.prop('checked', true);
          }
        }

        if (fieldDesc.onChange) {
          fieldDesc.onChange(input.val());
          input.on('change', function() {
            fieldDesc.onChange(input.val());
          });
        }

        let inputLine = $('<div class="layui-input-inline">');
        inputLine.append(input);

        return {label: label, input: inputLine};
      },
      jsonEditor.prototype.parseJson = function(json) {
        this.json = typeof(json) == 'object' ? json : okUtils.stringToJson(json);
        let fieldKey;
        for (fieldKey in this.fieldOption) {
          let fieldDesc = this.fieldOption[fieldKey];
          if (!fieldDesc.checkValid) {
            continue;
          }
          let checkResult = fieldDesc.checkValid(okUtils.getJsonValue(this.json, fieldKey), this.json);
          if (checkResult !== true) {
            this.error(checkResult);
            return false;
          }
        }
        return true;
      }
      jsonEditor.prototype.getValue = function() {
        let json = {};
        for (fieldKey in this.fieldOption) {
          let fieldDesc = this.fieldOption[fieldKey];
          let cb = $('#cb-'+fieldKey.replace('.', '-'))
          if (!cb.is(":checked")) continue;
          let input = $('#'+fieldKey.replace('.', '-'))
          let fieldValue = input.val();
          try {
            if (fieldDesc.parser === JSON.parse) {
              fieldValue = $.trim(fieldValue) == '' ? {} : fieldDesc.parser(fieldValue);
            } else if (fieldDesc.parser == parseInt) {
                if (!$.isNumeric(fieldValue)) {
                    throw 'Not a Number';
                }
                fieldValue = fieldDesc.parser(fieldValue);
            } else if (fieldDesc.parser) {
                fieldValue = fieldDesc.parser(fieldValue);
            }
          } catch (e) {
            this.error(fieldKey + ' parse error:' + e);
            console.log(e);
          }
          okUtils.setJsonValue(json, fieldKey, fieldValue);
        }
        return json;
      }

      let editor = new jsonEditor(parent.layui.$(parent.json_data).val(), parent.config_data);

      form.on('checkbox', function(data){
        let checked = data.elem.checked;
        let inputname = data.elem.getAttribute("inputname");
        let disabled = !checked;
        if (disabled) {
          $('#'+inputname).addClass('layui-disabled');
        } else {
          $('#'+inputname).removeClass('layui-disabled');
        }
        $('#'+inputname).prop('disabled', disabled);
        form.render();
      });

      form.on('submit(save)', function(data){
        let fields = editor.getValue();
        console.log(fields);
        parent.layui.$(parent.json_data).val(okUtils.jsonToString(fields));
        parent.layer.close(parent.layer.getFrameIndex(window.name));
        return false;
      });
   });
  </script>
</body>

</html>
